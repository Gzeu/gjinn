name: Deploy Gjinn to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Replace environment variables
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_POLLINATION_API_KEY: ${{ secrets.VITE_POLLINATION_API_KEY }}
        run: |
          echo "ðŸ”§ Configuring environment variables..."
          
          # Replace environment variable placeholders in index.html
          sed -i "s|{{ VITE_SUPABASE_URL }}|${VITE_SUPABASE_URL}|g" index.html
          sed -i "s|{{ VITE_SUPABASE_ANON_KEY }}|${VITE_SUPABASE_ANON_KEY}|g" index.html  
          sed -i "s|{{ VITE_POLLINATION_API_KEY }}|${VITE_POLLINATION_API_KEY}|g" index.html
          
          echo "âœ… Environment variables configured"
          
          # Verify no placeholders remain
          if grep -q "{{ VITE_" index.html; then
            echo "âš ï¸ Warning: Some environment variables may not be set"
            echo "Remaining placeholders:"
            grep "{{ VITE_" index.html || true
          else
            echo "âœ… All environment variables successfully replaced"
          fi

      - name: Validate application structure
        run: |
          echo "ðŸ”Ž Validating Gjinn application structure..."
          
          # Check required files
          required_files=("index.html" "app.js" "js/config.js" "js/daily-prompts.js" "js/supabase-integration.js")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file - Found"
            else
              echo "âŒ $file - Missing"
              exit 1
            fi
          done
          
          # Check CSS directory
          if [ -d "css" ]; then
            echo "âœ… css/ directory - Found"
            echo "   CSS files: $(ls css/*.css | wc -l)"
          else
            echo "âš ï¸ css/ directory - Missing"
          fi
          
          # Check database schema
          if [ -f "database/supabase-schema.sql" ]; then
            echo "âœ… Database schema - Found"
          else
            echo "âš ï¸ Database schema - Missing"
          fi
          
          echo "âœ¨ Application structure validation complete"

      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Post-deployment verification
        run: |
          echo "âœ¨ Gjinn successfully deployed to GitHub Pages!"
          echo "ðŸš€ Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "ðŸ“‹ Deployment includes:"
          echo "   âœ… Daily Creative Challenges (31 unique prompts)"
          echo "   âœ… Supabase authentication and user management"
          echo "   âœ… Pollination AI image generation with real links"
          echo "   âœ… Enhanced user experience and mobile support"
          echo "   âœ… Real-time image storage and retrieval"
          echo "   âœ… Completion streak tracking and gamification"
          echo ""
          echo "ðŸ“¡ Next steps:"
          echo "   1. Test the live application"
          echo "   2. Set up Supabase database using database/supabase-schema.sql"
          echo "   3. Configure OAuth providers (Google/GitHub) in Supabase"
          echo "   4. Test user registration and image storage"
          echo ""
          echo "ðŸŽ® Ready to grant creative wishes!"
        
      - name: Create deployment summary
        run: |
          echo "## ðŸ§žâ€â™‚ï¸ Gjinn Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸš€ Deployment Status:** Successful" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŒ Live URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Deploy Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ Features Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŸ Daily Creative Challenges (31 unique prompts)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Supabase authentication and user management" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¼ï¸ AI image generation with persistent storage" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± Mobile-optimized responsive design" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¥ Completion streak tracking system" >> $GITHUB_STEP_SUMMARY